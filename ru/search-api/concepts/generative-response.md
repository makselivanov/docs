# Генеративный ответ

Вы можете использовать текстовый поиск {{ search-api-name }} в сочетании с генеративными возможностями [{{ yagpt-name }}](../../foundation-models/concepts/yandexgpt/index.md), чтобы получить на поисковый запрос пользователя единый емкий и понятный _генеративный ответ_, при формировании которого нейросеть анализирует релевантные результаты текстового поиска {{ search-api-name }} по сайтам вашей компании. 

{% include [note-preview-by-request](../../_includes/note-preview.md) %}

Чтобы получить доступ к возможности генеративного ответа, заполните [форму](#contact-form) или обратитесь к вашему аккаунт-менеджеру.

## Поисковый запрос {#request}

Запросы к сервису {{ search-api-name }} на получение генеративного ответа отправляются методом POST на эндпойнт `{{ link-yandex }}/search/xml/generative`. 

Для выполнения запросов необходим [сервисный аккаунт](../../iam/concepts/users/service-accounts.md) с [ролью](../security/index.md#search-api-executor) `search-api.executor` и созданный для него [API-ключ](../../iam/concepts/authorization/api-key.md). Для успешной [авторизации](../operations/auth.md) передавайте в каждом запросе [идентификатор каталога](../../resource-manager/operations/folder/get-id.md) и API-ключ сервисного аккаунта.

### Формат запроса {#body}

Каждый запрос на получение генеративного ответа должен содержать тело запроса в формате [JSON](https://ru.wikipedia.org/wiki/JSON) следующего вида:

```json 
{
  "messages": [
    {
      "content": "<текст_сообщения_1>",
      "role": "user"
    },
    {
      "content": "<ответ_модели_1>",
      "role": "assistant"
    },
    {
      "content": "<текст_сообщения_2>",
      "role": "user"
    },
    {
      "content": "<ответ_модели_3>",
      "role": "assistant"
    },
    ...
    {
      "content": "<текст_сообщения_n>",
      "role": "user"
    }
  ],
  "site": "<адрес_сайта_для_поиска>",
  "host": "<хост_для_поиска>",
  "url": "<страница_для_поиска>"
}
```

### Параметры запроса

* `messages` — одиночный поисковый запрос или поисковый запрос с контекстом в форме чата с моделью. Задается в виде массива объектов, в каждом из которых содержатся два элемента:
    * `content` — текст запроса пользователя или ответа модели (в зависимости от значения элемента `role`).
    * `role` — роль автора сообщения. Возможные значения:
        * `user` — означает, что автор сообщения — пользователь, а в поле `content` — запрос пользователя.
        * `assistant` — означает, что автор сообщения — модель, а в поле `content` — ответ модели.

    Подробнее о режиме чата в {{ yagpt-name }} см. в разделе [{#T}](../../foundation-models/operations/yandexgpt/create-chat.md).

* `site` — ограничение области поиска релевантных документов по сайту, например `yandex.cloud`.

    Поиск будет выполняться по всем документам вида `*.yandex.cloud/*`. То есть, в область поиска попадут документы со следующими адресами:
    * `yandex.cloud/`
    * `subdomain.yandex.cloud/`
    * `yandex.cloud/path/`
    * `subdomain.yandex.cloud/path/`

    В поле `site` можно указать конкретный путь к области поиска, например `{{ link-docs }}`.
 
* `host` — ограничение области поиска релевантных документов по хосту, например `yandex.cloud/`.

    Поиск будет выполняться по всем документам вида `yandex.cloud/*`. То есть, в область поиска попадут документы со следующими адресами:
    * `yandex.cloud/`
    * `yandex.cloud/path/`

    В отличие от ограничения области поиска в поле `site`, заданное в поле `host` ограничение не распространяется на поддомены. В поле `host` также нельзя указать конкретный путь к области поиска.

* `url` — ограничение области поиска релевантных документов по странице, например `{{ link-docs }}/search-api/pricing`.

    {% note info %}

    Для ограничения области поиска достаточно указать в запросе одно из полей: `site`, `host` или `url`.

    Приоритет поля `host` выше, чем у поля `site`, а `url` в приоритете над `host`. Если в запросе передаются все три поля, область поиска будет ограничена значением поля `url`, а значение полей `host` и `site` будет проигнорировано.

    {% endnote %}

Пример тела запроса:

```json
{
  "messages": [
    {
      "content": "Сколько стоит {{ search-api-name }}?",
      "role": "user"
    }
  ],
  "site": "{{ link-docs }}"
}
```

### Отправка запроса {#send-request}

Чтобы отправить запрос, воспользуйтесь утилитой [cURL](https://curl.haxx.se) или языком программирования [Python](https://python.org/). Перед отправкой запроса сохраните [идентификатор каталога](../../resource-manager/operations/folder/get-id.md) и [API-ключ](../../iam/concepts/authorization/api-key.md) вашего сервисного аккаунта в переменные окружения:

```bash
export FOLDER_ID=<идентификатор_каталога>
export API_KEY=<API-ключ>
```

{% list tabs group=programming_language %}

- cURL {#curl}

  ```bash
  curl \
    --request POST \
    --header "Authorization: Api-Key ${API_KEY}" \
    --data "@<путь_к_файлу_с_телом_запроса>" \
    "{{ link-yandex }}/search/xml/generative?folderid=${FOLDER_ID}"
  ```

- Python 3 {#python}

  ```python
  import requests
  import os

  SEARCH_API_GENERATIVE = f"https://ya.ru/search/xml/generative?folderid={os.getenv('FOLDER_ID')}"

  
  def main():
      headers = {"Authorization": f"Api-Key {os.getenv('API_KEY')}"}
      data = {
          "messages": [
             {
                  "content": "Сколько стоит {{ search-api-name }}?",
                  "role": "user"
              }
          ],
          "url": "{{ link-docs }}/search-api/pricing"
      }

      response = requests.post(SEARCH_API_GENERATIVE, headers=headers, json=data)

      if "application/json" in response.headers["Content-Type"]:
          print(response.json()["message"]["content"])
          for i, link in enumerate(response.json()["links"], start=1):
              print(f"[{i}]: {link}")
      elif "text/xml" in response.headers["Content-Type"]:
          print("Error:", response.text)
      else:
          print("Unexpected content type:", response.text)


  if __name__ == "__main__":
      main()
  ```

{% endlist %}

## Генеративный ответ {#response}

Сервис {{ search-api-name }} возвращает ответ в формате JSON следующего вида:

```json
{
  "message": {
    "content": "<текст_ответа>",
    "role": "assistant"
  },
  "links": [
    "<ссылка_на_найденный_документ_1>",
    "<ссылка_на_найденный_документ_2>",
    ...
    "<ссылка_на_найденный_документ_n>"
  ],
  "titles": [
    "<заголовок_найденного_документа_1>",
    "<заголовок_найденного_документа_2>",
    ...
    "<заголовок_найденного_документа_n>"
  ],
  "final_search_query": "<доработанный_текст_запроса>",
  "is_answer_rejected": false (true),
  "is_bullet_answer": false (true),
  "search_reqid" : "...",
  "reqid" : "..."
}
```

Где:
* `content` — текст генеративного ответа.
* `links` — отсортированный список ссылок на документы, которые были найдены при запросе и могли использоваться {{ yagpt-name }} для формирования ответа.
* `titles` — отсортированный список заголовков документов.
* `final_search_query` — конечный вариант текста поискового запроса, доработанный моделью {{ yagpt-name }} и использованный при формировании генеративного ответа. Может отличаться от запроса, изначально переданного пользователем.
* `is_answer_rejected` — индикатор отказа модели предоставить ответ из-за этических ограничений:

    * `false` — модель вернула ответ.
    * `true` — модель отказалась вернуть ответ.

* `is_bullet_answer` — индикатор буллетного ответа, когда модель не может дать хороший ответ и предлагает набор буллетов с различной информацией.
* `search_reqid` — уникальный идентификатор запроса в Поиске от Яндекса.
* `reqid` — уникальный идентификатор запроса {{ search-api-name }}.

Пример генеративного ответа с ограничением по сайту:

```json
{
  "message": {
      "content": "Стоимость использования {{ search-api-name }} **рассчитывается исходя из количества инициированных поисковых запросов за календарный месяц**. [1]\n\n**Цена за 1000 запросов**, включая НДС: [1]\n- ночные запросы, первые 1000 запросов в месяц — не тарифицируется; [1]\n- ночные запросы, свыше 1000 запросов в месяц — 360 рублей; [1]\n- дневные запросы — 480 рублей. [1]\n\nДля всех новых пользователей сервиса действует квота в 30 000 запросов в месяц (1000 запросов в день). [1]\n\nЦены могут отличаться в разных регионах, а валюта оплаты зависит от юридического лица, с которым пользователь заключил договор. [1]",
      "role": "assistant"
  },
  "links": [
      "{{ link-docs }}/search-api/pricing",
      "{{ link-docs }}/search-api/concepts/generative-response",
      "{{ link-docs }}/api-gateway/pricing",
      "{{ link-docs }}/functions/pricing",
      "{{ link-docs }}/ydb/pricing/ru-docapi"
  ],
  "titles": [
      "Правила тарификации для {{ search-api-full-name }} | {{ yandex-cloud }} - Документация",
      "Генеративный ответ | {{ yandex-cloud }} - Документация",
      "Правила тарификации для {{ api-gw-full-name }} | {{ yandex-cloud }} - Документация",
      "Правила тарификации для {{ sf-name }} | {{ yandex-cloud }} - Документация",
      "Правила оценки стоимости запросов к ydb-short-name через Document API | {{ yandex-cloud }} - Документация"
  ],
  "final_search_query": "стоимость {{ search-api-name }}",
  "is_answer_rejected": false,
  "is_bullet_answer": false,
  "search_reqid": "1716922280912146-404265690610183965-**************-BAL",
  "reqid": "1716922280829905-8678730291785779856-********-l7leveler-***-**-***-***-BAL"
}
```

### Особенности ответа {#special-circumstances}

В зависимости от запроса и полученных результатов поиска, при формировании генеративного ответа {{ search-api-name }} может выдавать такие предупреждения:

* Если сервис не нашел ни одного документа по запросу:

    > **Ничего не нашлось.**
    > Переформулируйте запрос или спросите что-нибудь ещё.

* Если сервис нашел документы-источники по запросу, но извлечь из них информацию не получилось:

    > Не удалось извлечь информацию по запросу из найденных документов. Попробуйте открыть их самостоятельно или перейти к результатам поиска.

* Если сервис нашел документы-источники и извлек из них информацию, но нет уверенности в высоком качестве ответа, {{ search-api-name }} предваряет ответ следующим сообщением:

    > На сайтах по данной теме доступна различная информация, её обзор ниже.
