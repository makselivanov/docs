# Управление доступом на уровне строк данных (RLS)

RLS (_Row-level security_ — безопасность на уровне строк) позволяет ограничить доступ к данным для пользователей или [группы пользователей](../../organization/concepts/groups.md) в рамках одного датасета. Например, вы можете разграничить доступ разным клиентам.

{% include [rls-note](../../_includes/datalens/datalens-rls-note.md) %}

Разграничить доступ к данным на уровне строк можно как в [датасете](#dataset-rls), так и в [источнике данных](#datasource-rls).

## Настройка RLS на уровне датасета {#dataset-rls}

Вы можете разграничить доступ к любому измерению датасета. Каждому [пользователю](#user-rls) или [группе пользователей](#group-rls) могут быть выданы права на неограниченное количество значений измерений.

При использовании RLS запросы к датасету проходят через следующий фильтр:

```sql
where измерение in (значение_1, значение_2 ... значение_N)
```

### Доступ для пользователей {#user-rls}

Разграничение для пользователей определяется конфигурацией доступа, которая выглядит следующим образом:

```yaml
'значение_1': пользователь_1, пользователь_2
'значение_2': пользователь_3
'значение_3': пользователь_1, пользователь_2, пользователь_3
```

Например, чтобы настроить доступ пользователя `user-login` к значению `first-company` поля `Company name`, [задайте конфигурацию](#how-to-manage-rls):



```yaml
'first-company': user-login@yandex.ru
```


Чтобы настроить доступ для нескольких пользователей, перечислите через запятую их аккаунты в конфигурации доступа:



```yaml
'first-company': user-login-1@yandex.ru, user-login-2@yandex.ru, user-login-3@yandex.ru
```


### Доступ для групп пользователей {#group-rls}


Разграничение для групп пользователей определяется конфигурацией доступа, которая выглядит следующим образом:

```yaml
'значение_1': @group:название_группы_1
'значение_2': @group:название_группы_1, @group:название_группы_2
```

В конфигурации указывается название группы, а не ее идентификатор. Если группа будет переименована, конфигурацию RLS для нее нужно будет также обновить.

Например, чтобы настроить доступ группы пользователей с именем `group-name` к значению `first-company` поля `Company name`, задайте конфигурацию:

```yaml
'first-company': @group:group-name
```



Чтобы настроить доступ для нескольких групп пользователей, перечислите их через запятую в конфигурации доступа:


```yaml
'first-company': @group:group-name-1, @group:group-name-2, @group:group-name-3
```



Можно одновременно настроить доступ для пользователей и групп:


```yaml
'first-company': user-login-1@yandex.ru, user-login-2@yandex.ru, @group:group-name-1, @group:group-name-2
```



### Подстановки и кавычки в конфигурации RLS {#special-}

Значения, пользователей и названия групп можно определять символом подстановки:

* Пользователям `пользователь_1`, `пользователь_2` и группе `название_группы_1` доступны все значения поля

  ```yaml
  *: пользователь_1, пользователь_2, @group:название_группы_1
  ```

  Например, чтобы настроить доступ ко всем значениям поля `Company name`, задайте конфигурацию:


  ```yaml
  *: user-login-1@yandex.ru, @group:group-name-1
  ```


* Значение `значение_1` доступно всем пользователям и группам

  ```yaml
  'значение_1': *
  ```

  Например, чтобы разрешить доступ для всех пользователей и групп к значению `first-company` поля `Company name`, задайте конфигурацию:

  ```yaml
  'first-company': *
  ```

Кавычки в значении задаются удвоением:

```yaml
'значение в ''кавычках''': пользователь_1, пользователь_2
```

Например, чтобы установить кавычки для названия компании `first-company "Example"` поля `Company name`, задайте конфигурацию:


```yaml
'first-company ''Example''': user-login-1@yandex.ru, @group:group-name-1
```


Также можно использовать символ `"`:


```yaml
'first-company "Example"': user-login-1@yandex.ru, @group:group-name-1
```


## Настройка RLS на уровне источника данных {#datasource-rls}

Настройка RLS на уровне датасета предполагает его редактирование при каждом изменении настроек RLS. 

Чтобы избежать этого, можно перенести логику разграничения прав доступа на уровне строк на сторону источника данных:

1. В исходные данные добавьте новое поле для хранения id пользователя. По этому полю будет происходить фильтрация всех запросов в источник.

   
   Свой id можно посмотреть [по ссылке]({{ link-console-access-management }}). Если вам нужен id другого пользователя, попросите его открыть эту ссылку и передать id вам.


1. Для каждой строки исходных данных укажите id пользователя, которому должна быть доступна данная строка. Если к одной строке должен быть доступ для нескольких пользователей, то логику разграничения можно вынести в отдельную таблицу и [объединить](../dataset/settings.md#multi-table) ее с основной таблицей на уровне датасета.

1. В датасете в поле с id в настройках RLS введите `userid:userid`. Переменную `userid` можно использовать в сочетании с обычным типом RLS в датасете:

   ```yaml
   'значение_1': пользователь_1, пользователь_2
   'значение_2': пользователь_3
      userid:userid
   ```

{% note info %}

Перенос логики RLS на сторону источника возможен для источников, в которых доступно изменение структуры данных. В Metrica и AppMetrica структура данных закрыта, поэтому этот способ неприменим.

{% endnote %}

## Как изменить права доступа к строке в датасете {#how-to-manage-rls}

Чтобы настроить права доступа к значению строки данных:

{% include [datalens-manage-rls](../../_includes/datalens/operations/datalens-manage-rls.md) %}
