# Push-уведомления в {{ cns-full-name }}

_Push-уведомления_ — это всплывающие сообщения на экране смартфона с информацией о событии в сервисе, доступных услугах, акциях, новостях и обновлениях.

Push-уведомления отправляются через сервисы уведомлений мобильных платформ:
* [Apple Push Notification service](https://developer.apple.com/notifications/) (APNs).
* [Firebase Cloud Messaging](https://firebase.google.com/) (FCM).
* [Huawei Mobile Services](https://developer.huawei.com/consumer/) (HMS).

Позднее также будет реализована отправка Push-уведомлений через платформу [RuStore](https://www.rustore.ru/help/sdk/push-notifications).

{% include [limits-warning](../../_includes/notifications/limits-warning.md) %}

Алгоритм доставки Push-уведомлений на примере FCM:
1. В сервисе {{ cns-short-name }} создается [канал мобильных Push-уведомлений](#mobile-channel) под конкретную платформу (FCM) и ваше приложение.
1. FCM поддерживает постоянное сетевое соединение со всеми зарегистрированными мобильными устройствами, чтобы доставлять Push-уведомления приложениям на этих устройствах.
1. Ваше приложение на конкретном устройстве регистрируется в FCM и получает уникальный токен для отправки Push-уведомлений на это устройство.
1. Токен сохраняется в {{ cns-short-name }} в качестве параметра [мобильного эндпоинта](#mobile-endpoints) приложения. 
1. Чтобы отправить уведомление, вы публикуете сообщение в {{ cns-short-name }} и указываете в качестве получателя идентификатор (ARN) эндпоинта.

## Канал мобильных Push-уведомлений {#mobile-channel}

Минимальный перечень исходных данных для создания канала мобильных Push-уведомлений:

{% list tabs %}

- Apple iOS (APNs)

  {% include [auth-apns](../../_includes/notifications/auth-apns.md) %}

  Имя канала уведомлений должно быть уникальным в [облаке](../../resource-manager/concepts/resources-hierarchy.md#cloud). Для каналов APNs рекомендуется указывать в имени идентификатор приложения (Bundle ID).

- Google Android (FCM)

  {% include [auth-fcm](../../_includes/notifications/auth-fcm.md) %}

  Имя канала уведомлений должно быть уникальным в [облаке](../../resource-manager/concepts/resources-hierarchy.md#cloud). Для каналов FCM рекомендуется указывать в имени полное название пакета приложения (Package name).

- Huawei Android (HMS)

  {% include [auth-hms](../../_includes/notifications/auth-hms.md) %}

  Имя канала должно быть уникальным в [облаке](../../resource-manager/concepts/resources-hierarchy.md#cloud). Для HMS-каналов рекомендуется указывать в имени полное название пакета приложения (Package name).

{% endlist %}

После того как канал уведомлений создан, ему присваивается уникальный идентификатор (ARN).

## Мобильные эндпоинты {#mobile-endpoints}

Каждый канал имеет свою базу _мобильных эндпоинтов_ для отправки уведомлений напрямую в приложение на устройства пользователей.

Мобильный эндпоинт содержит в себе информацию о токене для отправки Push-уведомлений на конкретное устройство и идентификатор (ARN) канала уведомлений. 

## Время жизни токена {#token-lifetime}

Токены для отправки Push-уведомлений имеют ограниченное время жизни, которое зависит от конкретной платформы, действий пользователя и других факторов.

{{ cns-short-name }} при отправке уведомлений получает обратную связь от каждой платформы и использует ее для управления токенами. Если токен изменился, то {{ cns-short-name }} запишет в эндпоинт новый токен, или удалит эндпоинт, если токен устарел.

Рекомендуемый алгоритм работы с токенами на стороне мобильного приложения:
1. Приложение регистрируется в сервисе мобильных уведомлений, например APNs, и получает токен для отправки Push-уведомлений.
1. Приложение передает токен в {{ cns-short-name }}, получает идентификатор (ARN) эндпоинта и сохраняет его на устройстве.
1. При каждом запуске приложение снова регистрируется в сервисе мобильных уведомлений, например APNs, и проверяет, не изменился ли токен.
1. Если токен изменился, то приложение передает в {{ cns-short-name }} новый токен и идентификатор (ARN) эндпоинта. Если такого идентификатора (ARN) эндпоинта уже по какой-то причине нет, то в {{ cns-short-name }} создается новый эндпоинт и сохраняется в приложении.

{% note tip %}

Не рекомендуется постоянно перезаписывать токен в эндпоинт при каждом запуске приложения. Если токен не изменился, в некоторых случаях это может привести к потере уведомлений.

{% endnote %}

## См. также {#see-also}

* [Обзор сервиса](index.md)
* [Как начать работать с push-уведомлениями](../quickstart-push.md)
* [Как начать работать с сервисом с помощью AWS CLI](../tools/aws-cli.md)
* [SMS](sms.md)