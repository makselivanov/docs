# Хранилище в {{ mpg-name }}



{{ mpg-name }} позволяет использовать сетевые и локальные диски для организации хранилища кластеров баз данных. Сетевые диски реализованы на базе сетевых блоков — виртуальных дисков в инфраструктуре {{ yandex-cloud }}. Локальные диски физически размещаются в серверах хостов БД.

{% include [storage-type-nrd](../../_includes/mdb/mpg/storage-type.md) %}


## Выбор типа диска при создании кластера {#storage-type-selection}

Количество хостов, которые можно создать вместе с кластером {{ PG }}, зависит от выбранного типа диска:

* При использовании локальных SSD-дисков (`local-ssd`) или нереплицируемых SSD-дисков (`network-ssd-nonreplicated`) вы можете создать кластер из трех или более хостов.

    Такой кластер будет отказоустойчивым.

    Хранилище на локальных SSD-дисках влияет на тарификацию кластера: он тарифицируется, даже если остановлен. Подробнее см. в разделе [Правила тарификации](../pricing.md).

* При использовании сетевых HDD-дисков (`network-hdd`) или сетевых SSD-дисков (`network-ssd`) вы можете добавить любое количество хостов в пределах текущей квоты.

Подробнее об ограничениях на количество хостов в кластере см. в разделе [Квоты и лимиты](./limits.md).



## Управление дисковым пространством {#manage-storage-space}

При заполнении хранилища более чем на 97% хост автоматически переходит в режим read-only. При этом для всех баз данных через запрос `ALTER DATABASE` выставляется настройка `DEFAULT_TRANSACTION_READ_ONLY = TRUE`.

В этом режиме запросы на вставку (`INSERT`), удаление (`DELETE`) или обновление (`UPDATE`) данных завершаются ошибкой.


Вы можете отслеживать степень заполнения хранилища на хостах кластера, [настроив алерты в {{ monitoring-full-name }}](../operations/storage-space.md#set-alert).


### Вывод кластера из режима read-only {#read-only-solutions}

Воспользуйтесь одним из способов:

* [Увеличьте размер хранилища](../operations/storage-space.md#change-disk-size), чтобы выйти за пороговое значение. Тогда {{ mpg-short-name }} снимет режим read-only автоматически.

* [Вручную отключите режим read-only](../operations/storage-space.md#read-only-solutions) и освободите место в хранилище, удалив часть данных.

    {% note alert %}

    Не допускайте, чтобы в процессе этих действий свободное дисковое пространство уменьшилось до нуля. Поскольку предохранительный механизм отключен, {{ PG }} в этом случае аварийно завершит работу, а кластер станет неработоспособным.

    {% endnote %}

### Автоматическое увеличение размера хранилища {#auto-rescale}

Автоматическое увеличение размера хранилища позволяет избежать ситуаций, когда свободное место на диске заканчивается и хосты переходят в режим read-only. Хранилище увеличивается, когда достигнут установленный порог срабатывания — процент от общего объема хранилища. Есть два порога:

* Порог для планового увеличения. Когда он достигнут, объем хранилища увеличивается во время ближайшего [окна обслуживания](maintenance.md#maintenance-window).
* Порог для незамедлительного увеличения. Когда он достигнут, объем хранилища увеличивается немедленно.

Можно использовать один либо оба порога. Если заданы оба, порог для незамедлительного увеличения должен быть выше, чем для планового.

{% include [storage-resize-steps](../../_includes/mdb/mpg/storage-resize-steps.md) %}

Настроить автоматическое увеличение размера хранилища можно при [создании](../operations/cluster-create.md) или [изменении кластера](../operations/storage-space.md#disk-size-autoscale). Если настроен порог для планового увеличения, настройте расписание окна обслуживания.

{% include [warn-storage-resize](../../_includes/mdb/mpg/warn-storage-resize.md) %}
