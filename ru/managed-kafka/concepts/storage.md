# Хранилище в {{ mkf-name }}


{{ mkf-name }} позволяет использовать сетевые и локальные диски для организации хранилища кластеров баз данных. Сетевые диски реализованы на базе сетевых блоков — виртуальных дисков в инфраструктуре {{ yandex-cloud }}. Локальные диски физически размещаются в [серверах-брокерах](brokers.md).

{% include [storage-type-nrd](../../_includes/mdb/mkf/storage-type.md) %}


## Выбор типа диска при создании кластера {#storage-type-selection}


Количество хостов-брокеров, которые можно создать вместе с кластером {{ KF }}, зависит от выбранного типа диска:

* При использовании локальных SSD-дисков (`local-ssd`) или нереплицируемых SSD-дисков (`network-ssd-nonreplicated`) вы можете создать кластер из трех или более хостов-брокеров.

    Такой кластер будет отказоустойчивым, только если выполнены все [условия отказоустойчивости](index.md#fault-tolerance).

* При использовании сетевых HDD-дисков (`network-hdd`) или сетевых SSD-дисков (`network-ssd`) вы можете добавить любое количество хостов-брокеров в пределах текущей квоты.

Подробнее об ограничениях на количество хостов-брокеров в кластере см. в разделе [Квоты и лимиты](./limits.md).



## Минимальный размер хранилища {#minimal-storage-size}

Для работы каждого [топика](topics.md#topics) необходимо место в хранилище хостов-брокеров. Размер этого места зависит от фактора репликации и количества [разделов](topics.md#partitions). Если свободного места в хранилище меньше, создать новый топик невозможно.

{% note tip %}

Объем хранилища всегда можно [увеличить](../operations/storage-space.md#change-disk-size) в рамках действующих [квот]({{ link-console-quotas }}).

{% endnote %}

Минимальный размер хранилища для всех топиков рассчитывается по формуле:

`2 × максимальный размер сегмента логов × количество разделов в кластере × фактор репликации`.

Если разделы топиков распределены равномерно, для получения нужного размера хранилища разделите рассчитанное по формуле значение на число хостов-брокеров.

## Максимальный размер сегмента логов {#maximum-log-segment-size}

Для каждой реплики раздела топика необходимо как минимум два сегмента логов. Максимальный размер такого сегмента может быть определен:
* [на уровне топика](../operations/cluster-topics.md#update-topic) — настройкой [Segment bytes](settings-list.md#settings-topic-segment-bytes);
* глобально [на уровне кластера](../operations/cluster-update.md#change-kafka-settings) — настройкой [Log segment bytes](settings-list.md#settings-log-segment-bytes).

Таким образом, минимальный размер хранилища для всех топиков составляет: `2 × максимальный размер сегмента логов × количество разделов в кластере × фактор репликации`. Если разделы кластера распределены равномерно, получившуюся сумму можно поделить на количество брокеров, чтобы определить требуемый размер хранилища для одного брокера.

По умолчанию размер сегмента равен 1 ГБ.

## Автоматическое увеличение размера хранилища {#auto-rescale}

Автоматическое увеличение размера хранилища позволяет избежать ситуаций, когда свободное место на диске закончилось. Хранилище увеличивается, когда достигнут установленный порог срабатывания — процент от общего объема хранилища. Есть два порога:

* Порог для планового увеличения. Когда он достигнут, объем хранилища увеличивается во время ближайшего [окна обслуживания](maintenance.md#maintenance-window).
* Порог для незамедлительного увеличения. Когда он достигнут, объем хранилища увеличивается немедленно.

Можно использовать один либо оба порога. Если заданы оба, порог для незамедлительного увеличения должен быть выше, чем для планового.

{% include [storage-resize-steps](../../_includes/mdb/mkf/storage-resize-steps.md) %}

Настроить автоматическое увеличение размера хранилища можно при [создании](../operations/cluster-create.md) или [изменении кластера](../operations/storage-space.md#disk-size-autoscale). Если настроен порог для планового увеличения, настройте расписание окна обслуживания.

{% include [warn-storage-resize](../../_includes/mdb/mpg/warn-storage-resize.md) %}
